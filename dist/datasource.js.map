{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","console","info","jsonData","sensorid","apikey","type","name","q","withCredentials","headers","basicAuth","length","str","arr","baseUrl","url","opt","push","i","query","join","buildUrl","options","buildQueryParameters","targets","filter","t","hide","when","data","buildQueryUrl","doRequest","method","then","pq","parseQuery","x","result","data2","results","d","time","Object","keys","timevalue","Date","getTime","key","value","v","val","item","streams","_embedded","strnames","id","streamid","reverse","makeISOString","range","from","to","maxDataPoints","req","parseData","toISOString","first","last","retVal","td","idx","response","status","message","title","replace","annotation","annotationQuery","datasource","enable","iconColor","rangeRaw","interpolated","target","mapToTextValue","map","text","isObject","datasourceRequest","scopedVars","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\r\n\r\nexport class GenericDatasource {\r\n\r\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\r\n    console.info('current.json: ');\r\n    console.info(instanceSettings.jsonData);\r\n    this.sensorid = instanceSettings.jsonData['sensorid'];\r\n    this.apikey = instanceSettings.jsonData['apikey'];\r\n    this.type = instanceSettings.type;\r\n    this.name = instanceSettings.name;\r\n    this.q = $q;\r\n    this.backendSrv = backendSrv;\r\n    this.templateSrv = templateSrv;\r\n    this.withCredentials = instanceSettings.withCredentials;\r\n    this.headers = { 'Content-Type': 'application/json' };\r\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\r\n      this.headers['Authorization'] = instanceSettings.basicAuth;\r\n    }\r\n  }\r\n\r\n  buildUrl(str, arr) {\r\n    var baseUrl = \"https://sensor-cloud.io/api/sensor/v2\";\r\n    var url = baseUrl + str;\r\n\r\n\r\n\r\n    var opt = [];\r\n    opt.push('apikey=' + this.apikey);\r\n    if (arr) {\r\n      for (var i = 0; i < arr.length; ++i)\r\n        opt.push(arr[i]);\r\n    }\r\n\r\n    if (opt.length > 0) {\r\n      var query = opt.join('&');\r\n      url += '?' + query\r\n    }\r\n\r\n    console.info('buildUrl: ' + url)\r\n    return url;\r\n  }\r\n\r\n  buildQueryUrl(query) {\r\n\r\n    var arr = [];\r\n    //arr.push('');\r\n\r\n    var url = this.buildUrl(\"/streams\", arr);\r\n    return url;\r\n  }\r\n\r\n  query(options) {\r\n    var query = this.buildQueryParameters(options);\r\n\r\n    query.targets = query.targets.filter(t => !t.hide);\r\n\r\n    if (query.targets.length <= 0) {\r\n      return this.q.when({ data: [] });\r\n    }\r\n\r\n    // build URL\r\n    var arr = [];\r\n    var url = this.buildQueryUrl(query);\r\n\r\n    return this.doRequest({\r\n      url: url,\r\n      method: 'GET'\r\n    }).then(x => {\r\n      var pq = this.parseQuery(x, query);\r\n      console.info('returning query');\r\n      return pq;\r\n    }).then(x => {\r\n      console.info('done!');\r\n      return x;\r\n    });\r\n  }\r\n\r\n  parseData(data) {\r\n    console.info('parseData');\r\n    console.info(data);\r\n\r\n    var result = [];\r\n\r\n    var data2 = {};\r\n\r\n    for (var i = 0; i < data.results.length; ++i) {\r\n      var d = data.results[i];\r\n      var time = Object.keys(d)[0];\r\n      var timevalue = new Date(time).getTime();\r\n\r\n      //console.info('d=' + d);\r\n      for (var key in d[time]) {\r\n        //console.info('key=' + key);\r\n        var value = d[time][key].v;\r\n        if (value != null) {\r\n          //console.info('value' + value);\r\n\r\n          if (!(key in data2))\r\n          {\r\n            console.info('creating dict for ' + key);\r\n            data2[key] = [];\r\n          }\r\n\r\n          var val = [value, timevalue];\r\n          data2[key].push(val);\r\n        }\r\n      }\r\n    }\r\n\r\n    for (var key in data2) {\r\n      var item = {\r\n        \"target\": key,\r\n        \"datapoints\": data2[key]\r\n      };\r\n      result.push(item);\r\n    }\r\n    console.info('result');\r\n    console.info(result);\r\n    return result;\r\n  }\r\n\r\n  parseQuery(str, query) {\r\n\r\n    console.info('parseQuery');\r\n    console.info(str);\r\n    console.info(query);\r\n\r\n    var streams = str.data._embedded.streams;\r\n\r\n    var strnames = [];\r\n    for (var i = 0; i < streams.length; ++i) {\r\n      strnames.push(streams[i].id);\r\n    }\r\n    var streamid = strnames.reverse().join(\",\");\r\n\r\n    var arr = [];\r\n    arr.push('streamid=' + streamid);\r\n    arr.push('start=' + this.makeISOString(query.range.from));\r\n    arr.push('end=' + this.makeISOString(query.range.to));\r\n    arr.push('limit=' + query.maxDataPoints);\r\n    arr.push('sort=descending');\r\n\r\n    var url = this.buildUrl('/observations', arr);\r\n\r\n    var req = this.doRequest({\r\n      url: url,\r\n      method: 'GET'\r\n    }).then(x => {\r\n      x.data = this.parseData(x.data);\r\n      return x;\r\n    });\r\n\r\n    return req;\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n    /*\r\n    console.info(str);\r\n    console.info(query);\r\n\r\n    var data = [];\r\n    var data_result = {\r\n      data: data\r\n    };\r\n\r\n    var promise = this.q(() => {});\r\n\r\n    var streams = str.data._embedded.streams;\r\n    for (var i = 0; i < streams.length; ++i) {\r\n\r\n      (i => {\r\n        var id = streams[i].id;\r\n        console.info('id=');\r\n        console.info(id);\r\n        \r\n        promise.then(() => {\r\n      \r\n          var item = {\r\n            \"target\": id\r\n          };\r\n\r\n          var p1 = this.getDataPoints(id, query);\r\n          p1.then(y => {\r\n            console.info('setting datapoints');\r\n            item.datapoints = y.data;\r\n          });\r\n          console.info('resolving?');\r\n          Promise.resolve(p1);\r\n          console.info('resolved');\r\n          x.data.push(item);\r\n\r\n          console.info(x);\r\n          return x;\r\n        });\r\n      })(i);\r\n\r\n      \r\n\r\n      \r\n\r\n\r\n\r\n*/\r\n\r\n\r\n\r\n\r\n\r\n    /*\r\n    var item = {\r\n      \"target\": id\r\n    };\r\n\r\n    if(promise == null)\r\n    {\r\n      promise = this.getDataPoints(id, query);\r\n    }\r\n    promise.then(y => {\r\n\r\n    });\r\n    result.push(item);*/\r\n\r\n    /*\r\n          ((id, item) => {\r\n            promise.then(x => {\r\n    \r\n              console.info('getting getDataPoints promise');\r\n              return this.getDataPoints(id, query).then(y => {\r\n                console.info('setting datapoints');\r\n                item.datapoints = y.data;\r\n              });\r\n            });\r\n          })(id, item);\r\n    \r\n    \r\n    \r\n          result.push(item);*/\r\n\r\n\r\n\r\n\r\n    /*\r\n    promise.then(x => {\r\n      var prom = this.getDataPoints(id, query);\r\n      prom.then(y => {\r\n        item.datapoints = y.data;\r\n      });\r\n      return prom;\r\n    });*/\r\n\r\n    /*\r\n\r\n\r\n\r\n\r\n\r\n\r\n    // closure id\r\n    (id => {\r\n      console.info('inside closure');\r\n      promise.then(x => {\r\n        var item = {\r\n          \"target\": id\r\n        };\r\n\r\n        var dp1 = (item => {\r\n          console.info('inside closure2');\r\n                    \r\n        var dp = this.getDataPoints(id, query);\r\n        dp.then(x => {\r\n          console.info('x - dp');\r\n          console.info(x);\r\n          item.datapoints = x.data;\r\n        });\r\n        return dp;\r\n\r\n      })(item);\r\n\r\n        x.data.push(item);\r\n        return dp1;\r\n      });\r\n    })(id);*/\r\n    /*  }\r\n  \r\n      console.info('returning promise');\r\n      return promise;*/\r\n  }\r\n\r\n  makeISOString(v) {\r\n    if (v == null) { return null; }\r\n\r\n    console.info(v);\r\n    var str = v.toISOString();\r\n    console.info(str);\r\n    return str;\r\n  }\r\n\r\n\r\n  getDataPoints(id, query) {\r\n\r\n    console.info('getDataPoints');\r\n\r\n    var first = this.makeISOString(query.range.from);\r\n    var last = this.makeISOString(query.range.to);\r\n\r\n    console.info('query');\r\n    console.info(query);\r\n\r\n    var opt = [];\r\n    opt.push('streamid=' + id);\r\n    if (first != null)\r\n      opt.push('first=' + first);\r\n    if (last != null)\r\n      opt.push('last=' + last);\r\n\r\n    opt.push('limit=' + query.maxDataPoints);\r\n\r\n    console.info('options:');\r\n    console.info(opt);\r\n    var url = this.buildUrl('/observations', opt);\r\n\r\n    var req = this.doRequest({\r\n      url: url,\r\n      method: 'GET'\r\n    });\r\n\r\n    req.then(x => {\r\n      var results = x.data.results;\r\n\r\n      var retVal = [];\r\n\r\n      for (var i = 0; i < results.length; ++i) {\r\n        var val = results[i];\r\n        if (val.t != null && val.v != null && val.v.v != null) {\r\n          var td = new Date(val.t);\r\n          var t = td.getTime();\r\n          var v = val.v.v;\r\n          var idx = [v, t];\r\n          retVal.push(idx);\r\n        }\r\n      }\r\n\r\n      x.data = retVal;\r\n\r\n      return x;\r\n    });\r\n\r\n    return req;\r\n  }\r\n\r\n  testDatasource() {\r\n    return this.doRequest({\r\n      url: this.buildUrl('/'),\r\n      method: 'GET',\r\n    }).then(response => {\r\n      if (response.status === 200) {\r\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\r\n      }\r\n    });\r\n  }\r\n\r\n  annotationQuery(options) {\r\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\r\n    var annotationQuery = {\r\n      range: options.range,\r\n      annotation: {\r\n        name: options.annotation.name,\r\n        datasource: options.annotation.datasource,\r\n        enable: options.annotation.enable,\r\n        iconColor: options.annotation.iconColor,\r\n        query: query\r\n      },\r\n      rangeRaw: options.rangeRaw\r\n    };\r\n\r\n    return this.doRequest({\r\n      url: this.buildUrl('/annotations_not_implemented'),\r\n      method: 'POST',\r\n      data: annotationQuery\r\n    }).then(result => {\r\n      return result.data;\r\n    });\r\n  }\r\n\r\n  metricFindQuery(query) {\r\n    var interpolated = {\r\n      target: this.templateSrv.replace(query, null, 'regex')\r\n    };\r\n\r\n    console.info('metricFind');\r\n    console.info(interpolated);\r\n\r\n    return this.doRequest({\r\n      url: this.buildUrl('/search_not_implemented_yet'),\r\n      method: 'GET',\r\n    }).then(this.mapToTextValue);\r\n  }\r\n\r\n  mapToTextValue(result) {\r\n    return _.map(result.data, (d, i) => {\r\n      if (d && d.text && d.value) {\r\n        return { text: d.text, value: d.value };\r\n      } else if (_.isObject(d)) {\r\n        return { text: d, value: i };\r\n      }\r\n      return { text: d, value: d };\r\n    });\r\n  }\r\n\r\n  doRequest(options) {\r\n    options.withCredentials = this.withCredentials;\r\n    options.headers = this.headers;\r\n\r\n    return this.backendSrv.datasourceRequest(options);\r\n  }\r\n\r\n  buildQueryParameters(options) {\r\n    //remove placeholder targets\r\n    options.targets = _.filter(options.targets, target => {\r\n      return target.target !== 'select metric';\r\n    });\r\n\r\n    var targets = _.map(options.targets, target => {\r\n      return {\r\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\r\n        refId: target.refId,\r\n        hide: target.hide,\r\n        type: target.type || 'timeserie'\r\n      };\r\n    });\r\n\r\n    options.targets = targets;\r\n\r\n    return options;\r\n  }\r\n}\r\n"]}