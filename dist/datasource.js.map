{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","console","info","jsonData","sensorid","apikey","type","name","q","withCredentials","basicAuth","headers","length","str","arr","baseUrl","url","opt","push","i","query","join","buildUrl","options","buildQueryParameters","targets","filter","t","hide","when","data","buildQueryUrl","doRequest","method","then","pq","parseQuery","x","result","data2","results","d","time","Object","keys","timevalue","Date","getTime","key","value","v","val","item","streams","_embedded","strnames","id","streamid","reverse","makeISOString","range","from","to","maxDataPoints","req","parseData","toISOString","first","last","retVal","td","idx","response","status","message","title","replace","annotation","annotationQuery","datasource","enable","iconColor","rangeRaw","interpolated","target","mapToTextValue","map","text","isObject","datasourceRequest","scopedVars","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    console.info('current.json: ');\n    console.info(instanceSettings.jsonData);\n    console.info('instanceSettings');\n    console.info(instanceSettings);\n\n    if(instanceSettings.jsonData != null)\n    {\n      this.sensorid = instanceSettings.jsonData['sensorid'];\n      this.apikey = instanceSettings.jsonData['apikey'];\n    }\n    else\n    {\n      this.sensorid = \"\";\n      this.apikey = \"\";\n    }\n\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n    console.info('creds');\n    console.info(instanceSettings.withCredentials);\n\n    console.info('basic auth');\n    console.info(instanceSettings.basicAuth);\n\n    this.headers = { 'Content-Type': 'application/json' };\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n  }\n\n  buildUrl(str, arr) {\n    var baseUrl = \"https://sensor-cloud.io/api/sensor/v2\";\n    var url = baseUrl + str;\n\n\n\n    var opt = [];\n\n    if(this.apikey != \"\")\n      opt.push('apikey=' + this.apikey);\n\n    if (arr) {\n      for (var i = 0; i < arr.length; ++i)\n        opt.push(arr[i]);\n    }\n\n    if (opt.length > 0) {\n      var query = opt.join('&');\n      url += '?' + query\n    }\n\n    return url;\n  }\n\n  buildQueryUrl(query) {\n\n    var arr = [];\n    \n\n    if(this.sensorid != null)\n    {\n      arr.push('id=' + this.sensorid);\n    }\n\n    arr.push('resulttype=scalarvalue');\n\n    var url = this.buildUrl(\"/streams\", arr);\n    return url;\n  }\n\n  query(options) {\n    var query = this.buildQueryParameters(options);\n\n    query.targets = query.targets.filter(t => !t.hide);\n\n    if (query.targets.length <= 0) {\n      return this.q.when({ data: [] });\n    }\n\n    // build URL\n    var arr = [];\n    var url = this.buildQueryUrl(query);\n\n    return this.doRequest({\n      url: url,\n      method: 'GET'\n    }).then(x => {\n      var pq = this.parseQuery(x, query);\n      return pq;\n    }).then(x => {\n      return x;\n    });\n  }\n\n  parseData(data) {\n\n    var result = [];\n\n    var data2 = {};\n\n    for (var i = 0; i < data.results.length; ++i) {\n      var d = data.results[i];\n      var time = Object.keys(d)[0];\n      var timevalue = new Date(time).getTime();\n\n      for (var key in d[time]) {\n        var value = d[time][key].v;\n        if (value != null) {\n\n          if (!(key in data2))\n          {\n            data2[key] = [];\n          }\n\n          var val = [value, timevalue];\n          data2[key].push(val);\n        }\n      }\n    }\n\n    for (var key in data2) {\n      var item = {\n        \"target\": key,\n        \"datapoints\": data2[key]\n      };\n      result.push(item);\n    }\n    return result;\n  }\n\n  parseQuery(str, query) {\n\n\n    var streams = str.data._embedded.streams;\n\n    var strnames = [];\n    for (var i = 0; i < streams.length; ++i) {\n      strnames.push(streams[i].id);\n    }\n    var streamid = strnames.reverse().join(\",\");\n\n    var arr = [];\n    arr.push('streamid=' + streamid);\n    arr.push('start=' + this.makeISOString(query.range.from));\n    arr.push('end=' + this.makeISOString(query.range.to));\n    arr.push('limit=' + query.maxDataPoints);\n    arr.push('sort=descending');\n\n    var url = this.buildUrl('/observations', arr);\n\n    var req = this.doRequest({\n      url: url,\n      method: 'GET'\n    }).then(x => {\n      x.data = this.parseData(x.data);\n      return x;\n    });\n\n    return req;\n\n\n\n\n\n\n\n    \n  }\n\n  makeISOString(v) {\n    if (v == null) { return null; }\n\n    var str = v.toISOString();\n    return str;\n  }\n\n\n  getDataPoints(id, query) {\n\n\n    var first = this.makeISOString(query.range.from);\n    var last = this.makeISOString(query.range.to);\n\n\n\n    var opt = [];\n    opt.push('streamid=' + id);\n    if (first != null)\n      opt.push('first=' + first);\n    if (last != null)\n      opt.push('last=' + last);\n\n    opt.push('limit=' + query.maxDataPoints);\n\n    \n    var url = this.buildUrl('/observations', opt);\n\n    var req = this.doRequest({\n      url: url,\n      method: 'GET'\n    });\n\n    req.then(x => {\n      var results = x.data.results;\n\n      var retVal = [];\n\n      for (var i = 0; i < results.length; ++i) {\n        var val = results[i];\n        if (val.t != null && val.v != null && val.v.v != null) {\n          var td = new Date(val.t);\n          var t = td.getTime();\n          var v = val.v.v;\n          var idx = [v, t];\n          retVal.push(idx);\n        }\n      }\n\n      x.data = retVal;\n\n      return x;\n    });\n\n    return req;\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.buildUrl('/'),\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n      url: this.buildUrl('/annotations_not_implemented'),\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }\n\n  metricFindQuery(query) {\n    var interpolated = {\n      target: this.templateSrv.replace(query, null, 'regex')\n    };\n\n    console.info('metricFind');\n    console.info(interpolated);\n\n    return this.doRequest({\n      url: this.buildUrl('/search_not_implemented_yet'),\n      method: 'GET',\n    }).then(this.mapToTextValue);\n  }\n\n  mapToTextValue(result) {\n    return _.map(result.data, (d, i) => {\n      if (d && d.text && d.value) {\n        return { text: d.text, value: d.value };\n      } else if (_.isObject(d)) {\n        return { text: d, value: i };\n      }\n      return { text: d, value: d };\n    });\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  buildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select metric';\n    });\n\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie'\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n"]}