{"version":3,"sources":["../src/datasource.js"],"names":["_","DataParser","UrlBuilder","RequestCache","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","jsonData","sensorid","apikey","builder","url","type","name","q","withCredentials","console","debug","basicAuth","headers","length","requester","str","arr","buildUrl","targets","buildQueryUrl","options","query","buildQueryParameters","filter","t","hide","when","data","cacheKey","makeISOString","range","from","to","maxDataPoints","info","promise","doRequest","pq","parseQueryAgg","x","interpolated","target","replace","myHandler","obj","_embedded","streams","arr_reply","key","id","resulttype","push","mapToTextValue","myPromise","Promise","resolve","reject","then","parser","parseAggData","multiple","parseData","parseDataSingle","api_call","parse_func","extra_arr","streamid","join","promises","i","result","j","map","intervalMs","parseQueryExt","newData","doAllPromises","thePromise","status","ret","v","toISOString","count","Error","err","message","title","method","response","parseTestResult","annotation","annotationQuery","datasource","enable","iconColor","rangeRaw","d","text","value","isObject","datasourceRequest","scopedVars","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport { DataParser } from \"./dataparse.js\";\nimport { UrlBuilder } from \"./urlbuilder.js\";\nimport { RequestCache } from \"./requestcache.js\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n\n    if (instanceSettings.jsonData != null) {\n      this.sensorid = instanceSettings.jsonData['sensorid'] || \"\";\n      this.apikey = instanceSettings.jsonData['apikey'] || \"\";\n    }\n    else {\n      this.sensorid = \"\";\n      this.apikey = \"\";\n    }\n\n    this.builder = new UrlBuilder(instanceSettings.url, this.apikey, this.sensorid);\n\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n\n    console.debug('basic auth');\n    console.debug(instanceSettings.basicAuth);\n\n    this.headers = { 'Content-Type': 'application/json' };\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n\n    this.requester = new RequestCache(this.backendSrv, this.withCredentials, this.headers);\n\n  }\n\n  buildUrl(str, arr) {\n    return this.builder.buildUrl(str, arr);\n  }\n\n  buildQueryUrl(targets) {\n    return this.builder.buildQueryUrl(targets);\n  }\n\n  query(options) {\n    var query = this.buildQueryParameters(options);\n\n    query.targets = query.targets.filter(t => !t.hide);\n\n    if (query.targets.length <= 0) {\n      return this.q.when({ data: [] });\n    }\n\n    // build URL\n    var arr = [];\n    var url = this.buildQueryUrl(query.targets);\n\n    // request key to differentiate requests with different returning data but with same URL\n    var cacheKey = {\n      url: url,\n      query:\n      [\n        this.makeISOString(query.range.from),\n        this.makeISOString(query.range.to),\n        query.maxDataPoints,\n        query.targets\n      ]\n    };\n    console.info(\"cacheKey: \");\n    console.info(cacheKey);\n\n    var promise = this.requester.doRequest(url, cacheKey, x => {\n      console.info(\"parsing request\");\n      //var pq = this.parseQuery(x, query);\n      var pq = this.parseQueryAgg(x, query);\n      return pq;\n    });\n\n    return promise;\n  }\n\n\n  metricFindQuery(query) {\n    console.info('metricFindQuery');\n\n    var interpolated = {\n      target: this.templateSrv.replace(query, null, 'regex')\n    };\n\n    var url = this.buildQueryUrl();\n\n    var cacheKey = {\n      url: url,\n      query: \"findMetrics\"\n    };\n\n\n    var myHandler = x => {\n      var obj = x.data._embedded.streams;\n\n      var arr_reply = [];\n\n      for (var key in obj) {\n        var id = obj[key].id;\n        var type = obj[key].resulttype;\n\n        arr_reply.push(id);\n      }\n\n      return this.mapToTextValue({ data: arr_reply });\n    };\n\n    // get the promise\n    var promise = this.requester.doRequest(url, cacheKey);\n\n    // wrap around another promise\n    var myPromise = new Promise((resolve, reject) => {\n      resolve(promise);\n    });\n\n    return myPromise.then(myHandler);\n\n  }\n\n\n  parseAggData(data) {\n    console.info(\"parseAggData\");\n    console.info(data);\n\n    var parser = new DataParser();\n    return parser.parseAggData(data);\n  }\n\n  parseData(data, multiple) {\n    console.info(\"parseData\");\n    var parser = new DataParser();\n\n    if (multiple)\n      return parser.parseData(data);\n    return parser.parseDataSingle(data);\n  }\n\n  parseQueryExt(streams, query, api_call, parse_func, extra_arr) {\n    //var streams = str.data._embedded.streams;\n\n    var streamid = streams.join(\",\");\n\n    var arr = [];\n    arr.push('streamid=' + streamid);\n    arr.push('start=' + this.makeISOString(query.range.from));\n    arr.push('end=' + this.makeISOString(query.range.to));\n    arr.push('limit=' + query.maxDataPoints);\n    arr.push('sort=descending');\n    arr.push('media=json');\n\n    if (extra_arr != null)\n      arr.push(extra_arr);\n\n    var url = this.buildUrl(api_call, arr);\n\n    var cacheKey = { url: url, query: \"extended\" };\n\n    var multiple = streams.length > 1;\n\n    var promise = this.requester.doRequest(url, cacheKey, parse_func);/*x => {\n      x.data = this.parseData(x.data, multiple);\n      return x;\n    });*/\n\n    return promise;\n  }\n\n\n  async doAllPromises(promises) {\n\n    console.info(\"doAllPromises: \" + promises.length);\n    var data = [];\n\n    for (var i = 0; i < promises.length; ++i) {\n      var promise = promises[i];\n      console.info(\"awaiting - \" + i);\n      var result = await promise;\n      console.info(\"awaited\")\n      \n\n      for(var j=0; j<result.data.length; ++j)\n      {\n        data.push(result.data[j]);\n      }\n    }\n\n    console.info(\"data=\");\n    console.info(data);\n\n    return {data: data};\n  }\n\n\n  parseQueryAgg(str, query) {\n    var streams = str.data._embedded.streams;\n    streams = streams.map(x => x.id)\n    console.info(\"parseQueryAgg\");\n    console.info(streams);\n\n    var promises = [];\n\n    for (var i = 0; i < streams.length; ++i) {\n      var str = streams[i];\n      var multiple = streams.length > 1;\n\n      var arr = [\"aggperiod=\" + query.intervalMs];\n      var promise = this.parseQueryExt([str], query, '/aggregation', x => {\n        var newData = this.parseAggData(x.data);\n        x.data = newData;\n        return x;\n      }, arr);\n      promises.push(promise);\n    }\n\n\n    return this.doAllPromises(promises);\n\n\n    var thePromise = new Promise((resolve, reject) => {\n      resolve(promises);\n    });\n\n    thePromise.then(x => {\n\n\n\n\n\n      var result = [];\n      for (var i = 0; i < x.length; ++i) {\n        if (x[i].status != 200)\n          throw 'error';\n\n        for (var j = 0; j < x[i].data.length; ++j)\n          result.push(x[i].data[j]);\n      }\n      console.info(\"final promise\");\n      console.info(result);\n\n      var ret = { data: result };\n      console.info(\"FINAL: \");\n      console.info(ret);\n      return ret;\n    });\n    return thePromise;\n  }\n\n  parseQuery(str, query) {\n    var streams = str.data._embedded.streams;\n    streams = streams.map(x => x.id);\n\n    var multiple = streams.length > 1;\n    return this.parseQueryExt(streams, query, '/observations', x => {\n      x.data = this.parseData(x.data, multiple);\n      return x;\n    });\n  }\n\n  makeISOString(v) {\n    if (v == null) { return null; }\n\n    var str = v.toISOString();\n    return str;\n  }\n\n  parseTestResult(data) {\n    try {\n      var count = data.count;\n      if (count > 1000)\n        throw Error('too many streams, plugin only supports up to 1000');\n    }\n    catch (err) {\n      return { status: \"error\", message: err.message, title: \"Error\" };\n    }\n\n    return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n  }\n\n  testDatasource() {\n    var url = this.buildQueryUrl();\n\n    return this.doRequest({\n      url: url,\n      method: 'GET',\n    }).then(response => {\n      console.info(\"response=\" + response.status);\n      if (response.status === 200) {\n        console.info(\"Response = 200\");\n\n\n        return this.parseTestResult(response.data);\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n      url: this.buildUrl('/annotations_not_implemented'),\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }\n\n\n\n  mapToTextValue(result) {\n    return _.map(result.data, (d, i) => {\n      if (d && d.text && d.value) {\n        return { text: d.text, value: d.value };\n      } else if (_.isObject(d)) {\n        return { text: d, value: i };\n      }\n      return { text: d, value: d };\n    });\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    var promise = this.backendSrv.datasourceRequest(options);\n    promise.then(x => {\n      console.info(\"performing HTTP request\");\n      return x;\n    })\n    return promise;\n  }\n\n  buildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select metric';\n    });\n\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie'\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n"]}