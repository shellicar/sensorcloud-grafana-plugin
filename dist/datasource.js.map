{"version":3,"sources":["../src/datasource.js"],"names":["_","DataParser","UrlBuilder","RequestCache","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","jsonData","sensorid","apikey","builder","type","name","q","withCredentials","console","debug","basicAuth","headers","length","requester","str","arr","buildUrl","targets","buildQueryUrl","options","query","buildQueryParameters","info","filter","t","hide","when","data","url","cacheKey","makeISOString","range","from","to","maxDataPoints","promise","doRequest","pq","parseQuery","x","interpolated","target","replace","myHandler","obj","_embedded","streams","arr_reply","key","id","resulttype","push","mapToTextValue","myPromise","Promise","resolve","reject","then","multiple","parser","parseData","parseDataSingle","streamid","map","join","v","toISOString","count","Error","err","status","message","title","method","response","parseTestResult","annotation","annotationQuery","datasource","enable","iconColor","rangeRaw","result","d","i","text","value","isObject","datasourceRequest","scopedVars","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport { DataParser } from \"./dataparse.js\";\nimport { UrlBuilder } from \"./urlbuilder.js\";\nimport { RequestCache } from \"./requestcache.js\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n\n    if (instanceSettings.jsonData != null) {\n      this.sensorid = instanceSettings.jsonData['sensorid'] || \"\";\n      this.apikey = instanceSettings.jsonData['apikey'] || \"\";\n    }\n    else {\n      this.sensorid = \"\";\n      this.apikey = \"\";\n    }\n    this.builder = new UrlBuilder(this.apikey, this.sensorid);\n\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n\n    console.debug('basic auth');\n    console.debug(instanceSettings.basicAuth);\n\n    this.headers = { 'Content-Type': 'application/json' };\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n\n    this.requester = new RequestCache(this.backendSrv, this.withCredentials, this.headers);\n\n  }\n\n  buildUrl(str, arr) {\n    return this.builder.buildUrl(str, arr);\n  }\n\n  buildQueryUrl(targets) {\n    return this.builder.buildQueryUrl(targets);\n  }\n\n  query(options) {\n    var query = this.buildQueryParameters(options);\n    console.info('optionss');\n    console.info(options);\n\n    query.targets = query.targets.filter(t => !t.hide);\n\n    if (query.targets.length <= 0) {\n      return this.q.when({ data: [] });\n    }\n\n    // build URL\n    var arr = [];\n    var url = this.buildQueryUrl(query.targets);\n\n    // request key to differentiate requests with different returning data but with same URL\n    var cacheKey = {\n      url: url,\n      query:\n      [\n        this.makeISOString(query.range.from),\n        this.makeISOString(query.range.to),\n        query.maxDataPoints\n      ]\n    };\n\n    var promise = this.requester.doRequest(url, cacheKey, x => {\n      var pq = this.parseQuery(x, query);\n      return pq;\n    });\n\n    return promise;\n  }\n\n\n  metricFindQuery(query) {\n    console.info('metricFindQuery');\n\n    var interpolated = {\n      target: this.templateSrv.replace(query, null, 'regex')\n    };\n\n    var url = this.buildQueryUrl();\n\n    var cacheKey = {\n      url: url,\n      query: \"findMetrics\"\n    };\n\n\n    var myHandler = x => {\n      var obj = x.data._embedded.streams;\n      \n      var arr_reply = [];\n\n      for(var key in obj)\n      {\n        var id = obj[key].id;\n        var type = obj[key].resulttype;\n\n        //if(type == \"scalarvalue\")\n        {\n          arr_reply.push(id);\n        }/*\n        else if(type == \"geolocationvalue\")\n        {\n          arr_reply.push(id + \"_lat\");\n          arr_reply.push(id + \"_lon\");\n          arr_reply.push(id + \"_alt\");\n        }*/\n      }\n\n      return this.mapToTextValue({data: arr_reply});\n\n\n            /*\n\n      var ret = obj.map(y => y.id);\n\n      console.info('x=');\n      console.info(x);\n\n      var result = this.mapToTextValue({ data: ret });\n      return result;*/\n    };\n\n    // get the promise\n    var promise = this.requester.doRequest(url, cacheKey);\n\n    // wrap around another promise\n    var myPromise = new Promise((resolve, reject) => {\n      resolve(promise);\n    });\n\n    return myPromise.then(myHandler);\n\n\n\n    /*\n\n    promise.then(x => {\n      console.info('x=');\n      console.info(x);\n      var obj = x.data._embedded.streams;\n      var ret = obj.map(y => y.id);\n      console.info('ret=');\n      console.info(ret);\n      var result = this.mapToTextValue({ 'data': ret });\n      console.info('result');\n      console.info(result);\n      return result;\n    });*/\n\n    /*, x => {\n      var obj = x.data._embedded.streams;\n      var ret = obj.map(y => y.id);\n      return this.mapToTextValue({data: ret});\n    });*/\n\n    \n\n\n    /*\n    return this.doRequest({\n      url: url,\n      method: 'GET',\n    }).then(x => {\n      var obj = x.data._embedded.streams;\n      var ret = obj.map(y => y.id);\n      return this.mapToTextValue({data: ret});\n    });*/\n  }\n\n\n\n  parseData(data, multiple) {\n    console.info(\"parseData\");\n    var parser = new DataParser();\n\n    if (multiple)\n      return parser.parseData(data);\n    return parser.parseDataSingle(data);\n  }\n\n  parseQuery(str, query) {\n    console.info(\"parseQuery\");\n\n    var streams = str.data._embedded.streams;\n\n    var streamid = streams.map(x => x.id).join(\",\");\n\n    var arr = [];\n    arr.push('streamid=' + streamid);\n    arr.push('start=' + this.makeISOString(query.range.from));\n    arr.push('end=' + this.makeISOString(query.range.to));\n    arr.push('limit=' + query.maxDataPoints);\n    arr.push('sort=descending');\n    arr.push('media=json');\n\n    var url = this.buildUrl('/observations', arr);\n\n    var cacheKey = { url: url, query: \"extended\" };\n\n    var multiple = streams.length > 1;\n\n    var promise = this.requester.doRequest(url, cacheKey, x => {\n      x.data = this.parseData(x.data, multiple);\n      return x;\n    });\n\n    return promise;\n  }\n\n  makeISOString(v) {\n    if (v == null) { return null; }\n\n    var str = v.toISOString();\n    return str;\n  }\n\n  parseTestResult(data) {\n    try {\n      var count = data.count;\n      if (count > 100)\n        throw Error('too many streams, plugin only supports up to 100');\n    }\n    catch (err) {\n      return { status: \"error\", message: err.message, title: \"Error\" };\n    }\n\n    return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n  }\n\n  testDatasource() {\n    var url = this.buildQueryUrl();\n\n    return this.doRequest({\n      url: url,\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        console.info(\"Response = 200\");\n\n        return this.parseTestResult(response.data);\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n      url: this.buildUrl('/annotations_not_implemented'),\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }\n\n\n\n  mapToTextValue(result) {\n    return _.map(result.data, (d, i) => {\n      if (d && d.text && d.value) {\n        return { text: d.text, value: d.value };\n      } else if (_.isObject(d)) {\n        return { text: d, value: i };\n      }\n      return { text: d, value: d };\n    });\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    var promise = this.backendSrv.datasourceRequest(options);\n    promise.then(x => {\n      console.info(\"performing HTTP request\");\n      return x;\n    })\n    return promise;\n  }\n\n  buildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select metric';\n    });\n\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie'\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n"]}