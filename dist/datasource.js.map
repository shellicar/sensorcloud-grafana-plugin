{"version":3,"sources":["../src/datasource.js"],"names":["_","DataParser","UrlBuilder","RequestCache","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","jsonData","sensorid","apikey","builder","type","name","q","withCredentials","console","debug","basicAuth","headers","length","requester","str","arr","buildUrl","targets","buildQueryUrl","options","query","buildQueryParameters","filter","t","hide","when","data","url","cacheKey","makeISOString","range","from","to","maxDataPoints","promise","doRequest","pq","parseQueryAgg","x","info","interpolated","target","replace","myHandler","obj","_embedded","streams","arr_reply","key","id","resulttype","push","mapToTextValue","myPromise","Promise","resolve","reject","then","parser","parseAggData","multiple","parseData","parseDataSingle","api_call","parse_func","extra_arr","error","streamid","join","promises","i","result","j","map","intervalMs","parseQueryExt","newData","doAllPromises","thePromise","status","ret","v","toISOString","count","Error","err","message","title","method","response","parseTestResult","annotation","annotationQuery","datasource","enable","iconColor","rangeRaw","d","text","value","isObject","datasourceRequest","scopedVars","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport { DataParser } from \"./dataparse.js\";\nimport { UrlBuilder } from \"./urlbuilder.js\";\nimport { RequestCache } from \"./requestcache.js\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n\n    if (instanceSettings.jsonData != null) {\n      this.sensorid = instanceSettings.jsonData['sensorid'] || \"\";\n      this.apikey = instanceSettings.jsonData['apikey'] || \"\";\n    }\n    else {\n      this.sensorid = \"\";\n      this.apikey = \"\";\n    }\n    this.builder = new UrlBuilder(this.apikey, this.sensorid);\n\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n\n    console.debug('basic auth');\n    console.debug(instanceSettings.basicAuth);\n\n    this.headers = { 'Content-Type': 'application/json' };\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n\n    this.requester = new RequestCache(this.backendSrv, this.withCredentials, this.headers);\n\n  }\n\n  buildUrl(str, arr) {\n    return this.builder.buildUrl(str, arr);\n  }\n\n  buildQueryUrl(targets) {\n    return this.builder.buildQueryUrl(targets);\n  }\n\n  query(options) {\n    var query = this.buildQueryParameters(options);\n\n    query.targets = query.targets.filter(t => !t.hide);\n\n    if (query.targets.length <= 0) {\n      return this.q.when({ data: [] });\n    }\n\n    // build URL\n    var arr = [];\n    var url = this.buildQueryUrl(query.targets);\n\n    // request key to differentiate requests with different returning data but with same URL\n    var cacheKey = {\n      url: url,\n      query:\n      [\n        this.makeISOString(query.range.from),\n        this.makeISOString(query.range.to),\n        query.maxDataPoints,\n        query.targets\n      ]\n    };\n\n    var promise = this.requester.doRequest(url, cacheKey, x => {\n\n      //var pq = this.parseQuery(x, query);\n      var pq = this.parseQueryAgg(x, query);\n      return pq;\n    });\n\n    return promise;\n  }\n\n\n  metricFindQuery(query) {\n    console.info('metricFindQuery');\n\n    var interpolated = {\n      target: this.templateSrv.replace(query, null, 'regex')\n    };\n\n    var url = this.buildQueryUrl();\n\n    var cacheKey = {\n      url: url,\n      query: \"findMetrics\"\n    };\n\n\n    var myHandler = x => {\n      var obj = x.data._embedded.streams;\n\n      var arr_reply = [];\n\n      for (var key in obj) {\n        var id = obj[key].id;\n        var type = obj[key].resulttype;\n\n        arr_reply.push(id);\n      }\n\n      return this.mapToTextValue({ data: arr_reply });\n    };\n\n    // get the promise\n    var promise = this.requester.doRequest(url, cacheKey);\n\n    // wrap around another promise\n    var myPromise = new Promise((resolve, reject) => {\n      resolve(promise);\n    });\n\n    return myPromise.then(myHandler);\n\n  }\n\n\n  parseAggData(data) {\n    console.info(\"parseAggData\");\n    console.info(data);\n\n    var parser = new DataParser();\n    return parser.parseAggData(data);\n  }\n\n  parseData(data, multiple) {\n    console.info(\"parseData\");\n    var parser = new DataParser();\n\n    if (multiple)\n      return parser.parseData(data);\n    return parser.parseDataSingle(data);\n  }\n\n  parseQueryExt(streams, query, api_call, parse_func, extra_arr) {\n    //var streams = str.data._embedded.streams;\n\n    console.error(\"streams\");\n    console.error(streams);\n\n    var streamid = streams.join(\",\");\n\n    var arr = [];\n    arr.push('streamid=' + streamid);\n    arr.push('start=' + this.makeISOString(query.range.from));\n    arr.push('end=' + this.makeISOString(query.range.to));\n    arr.push('limit=' + query.maxDataPoints);\n    arr.push('sort=descending');\n    arr.push('media=json');\n\n    if (extra_arr != null)\n      arr.push(extra_arr);\n\n    var url = this.buildUrl(api_call, arr);\n\n    var cacheKey = { url: url, query: \"extended\" };\n\n    var multiple = streams.length > 1;\n\n    var promise = this.requester.doRequest(url, cacheKey, parse_func);/*x => {\n      x.data = this.parseData(x.data, multiple);\n      return x;\n    });*/\n\n    return promise;\n  }\n\n\n  async doAllPromises(promises) {\n\n    console.info(\"doAllPromises: \" + promises.length);\n    var data = [];\n\n    for (var i = 0; i < promises.length; ++i) {\n      var promise = promises[i];\n      console.info(\"awaiting - \" + i);\n      var result = await promise;\n      console.info(\"awaited\")\n      \n\n      for(var j=0; j<result.data.length; ++j)\n      {\n        data.push(result.data[j]);\n      }\n    }\n\n    console.info(\"data=\");\n    console.info(data);\n\n    return {data: data};\n  }\n\n\n  parseQueryAgg(str, query) {\n    var streams = str.data._embedded.streams;\n    streams = streams.map(x => x.id)\n    console.info(\"parseQueryAgg\");\n    console.info(streams);\n\n    var promises = [];\n\n    for (var i = 0; i < streams.length; ++i) {\n      var str = streams[i];\n      console.error(\"str=\" + str);\n      var multiple = streams.length > 1;\n\n      var arr = [\"aggperiod=\" + query.intervalMs];\n      var promise = this.parseQueryExt([str], query, '/aggregation', x => {\n        var newData = this.parseAggData(x.data);\n        x.data = newData;\n        return x;\n      }, arr);\n      promises.push(promise);\n    }\n\n\n    return this.doAllPromises(promises);\n\n\n    var thePromise = new Promise((resolve, reject) => {\n      resolve(promises);\n    });\n\n    thePromise.then(x => {\n\n\n\n\n\n      var result = [];\n      for (var i = 0; i < x.length; ++i) {\n        if (x[i].status != 200)\n          throw 'error';\n\n        for (var j = 0; j < x[i].data.length; ++j)\n          result.push(x[i].data[j]);\n      }\n      console.info(\"final promise\");\n      console.info(result);\n\n      var ret = { data: result };\n      console.info(\"FINAL: \");\n      console.info(ret);\n      return ret;\n    });\n    return thePromise;\n  }\n\n  parseQuery(str, query) {\n    var streams = str.data._embedded.streams;\n    console.error(\"streams\");\n    console.error(streams);;\n    streams = streams.map(x => x.id);\n    console.error(streams);\n\n    var multiple = streams.length > 1;\n    return this.parseQueryExt(streams, query, '/observations', x => {\n      x.data = this.parseData(x.data, multiple);\n      return x;\n    });\n  }\n\n  makeISOString(v) {\n    if (v == null) { return null; }\n\n    var str = v.toISOString();\n    return str;\n  }\n\n  parseTestResult(data) {\n    try {\n      var count = data.count;\n      if (count > 1000)\n        throw Error('too many streams, plugin only supports up to 1000');\n    }\n    catch (err) {\n      return { status: \"error\", message: err.message, title: \"Error\" };\n    }\n\n    return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n  }\n\n  testDatasource() {\n    var url = this.buildQueryUrl();\n\n    return this.doRequest({\n      url: url,\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        console.info(\"Response = 200\");\n\n        return this.parseTestResult(response.data);\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n      url: this.buildUrl('/annotations_not_implemented'),\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }\n\n\n\n  mapToTextValue(result) {\n    return _.map(result.data, (d, i) => {\n      if (d && d.text && d.value) {\n        return { text: d.text, value: d.value };\n      } else if (_.isObject(d)) {\n        return { text: d, value: i };\n      }\n      return { text: d, value: d };\n    });\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    var promise = this.backendSrv.datasourceRequest(options);\n    promise.then(x => {\n      console.info(\"performing HTTP request\");\n      return x;\n    })\n    return promise;\n  }\n\n  buildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select metric';\n    });\n\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie'\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n"]}